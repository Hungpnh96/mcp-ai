<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MCP-AI Test Lab</title>
  <style>
    :root {
      color-scheme: dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #050915;
      color: #e5e7eb;
      min-height: 100vh;
    }
    header {
      background: rgba(11, 16, 32, 0.95);
      border-bottom: 1px solid #1f2937;
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .container {
      width: min(1100px, 100%);
      margin: 0 auto;
      padding: 0 20px;
    }
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
    }
    nav a {
      text-decoration: none;
      color: #93c5fd;
      font-weight: 600;
    }
    nav a:hover { color: #bfdbfe; }
    h1 {
      margin: 32px 0 12px;
      font-size: clamp(24px, 4vw, 32px);
    }
    p.lead {
      margin: 0 0 32px;
      color: #9ca3af;
      max-width: 600px;
    }
    .card {
      background: #0b1123;
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 15px 40px rgba(2, 6, 23, 0.35);
    }
    label { display: block; margin-bottom: 6px; color: #93c5fd; }
    input[type="text"], input[type="url"] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #030712;
      color: #e5e7eb;
    }
    input:focus { outline: 2px solid #2563eb; }
    button {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: white;
      border: 0;
      border-radius: 999px;
      padding: 12px 18px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
    }
    button:hover { transform: translateY(-1px); }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }
    pre {
      background: #030712;
      color: #d1d5db;
      padding: 16px;
      border-radius: 12px;
      overflow: auto;
      max-height: 60vh;
      border: 1px solid #1f2937;
    }
    pre.curl { font-size: 13px; margin-top: 12px; }
    small { color: #9ca3af; }
    section .group-title { color: #fcd34d; font-weight: 600; margin: 0 0 16px; letter-spacing: .04em; text-transform: uppercase; }
    audio { width: 100%; margin-top: 12px; border-radius: 12px; }
    .hidden { display: none; }
    #direct128 { color: #ef4444; word-break: break-all; display: inline-block; margin-top: 10px; }
    footer {
      text-align: center;
      color: #6b7280;
      margin: 48px 0 24px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <a href="/">← Về MCP-AI Control Center</a>
        <span style="font-weight:600; color:#fcd34d;">MCP-AI Test Lab</span>
      </nav>
    </div>
  </header>
  <main class="container">
    <h1>MCP-AI Test Lab</h1>
    <p class="lead">Phân tách rõ Âm nhạc và Tin tức để kiểm thử nhanh. Mỗi thẻ cung cấp hành động phổ biến kèm đoạn lệnh cURL để copy.</p>

    <section class="card">
      <div class="group-title">Âm nhạc · Tìm kiếm bài hát</div>
      <div class="row">
        <div>
          <label>Từ khóa</label>
          <input id="kw" type="text" placeholder="ví dụ: lạc trôi" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <button id="btnSearchV2">Gọi /api/search</button>
        </div>
      </div>
      <pre class="curl" id="curlSearch">curl "http://localhost:8002/api/search?q=<từ-khóa>"</pre>
    </section>

    <section class="card">
      <div class="group-title">Âm nhạc · Song ID</div>
      <div class="row">
        <div>
          <label>Song ID</label>
          <input id="songId" type="text" placeholder="vd: ZOACFBBU" />
        </div>
        <div style="display:flex; align-items:flex-end; flex-wrap:wrap; gap:10px;">
          <button id="btnPlay">Phát nhạc</button>
          <button id="btnGetLink">Link Stream</button>
          <button id="btnInfoSong">Thông tin</button>
          <button id="btnLyric">Lời bài hát</button>
        </div>
      </div>
      <div class="row" style="margin-top:16px;">
        <div>
          <label>cURL Link stream</label>
          <pre class="curl" id="curlGetLink">curl "http://localhost:8002/api/song?id=<songId>"</pre>
        </div>
        <div>
          <label>cURL Lyric</label>
          <pre class="curl" id="curlLyric">curl "http://localhost:8002/api/lyric?id=<songId>"</pre>
        </div>
      </div>
      <audio id="player" class="hidden" controls></audio>
      <a id="direct128" class="hidden" target="_blank" rel="noreferrer noopener">Link phát trực tiếp</a>
      <small id="note128" class="hidden">Mặc định chất lượng 128kbps; dùng URL stream để phát ngoài.</small>
    </section>

    <section class="card">
      <div class="group-title">Tin tức · VNExpress</div>
      <div class="row">
        <div>
          <label>Chuyên mục</label>
          <select id="newsCategorySelect">
            <option value="latest">Tin mới nhất</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <button id="btnNewsFetch">Fetch tin</button>
        </div>
      </div>
      <pre class="curl" id="curlNews">curl "http://localhost:8002/api/news/latest"</pre>
    </section>

    <section class="card">
      <label>Kết quả</label>
      <pre id="out">(chưa có dữ liệu)</pre>
    </section>
  </main>

  <footer>
    © 2025 mp3-proxy | Sử dụng cho mục đích kiểm thử.
  </footer>

  <script>
    const out = document.getElementById('out');
    const setOut = (d) => out.textContent = typeof d === 'string' ? d : JSON.stringify(d, null, 2);
    function pickSongFields(s) {
      return {
        encodeId: s?.encodeId,
        title: s?.title,
        artistsNames: s?.artistsNames,
        duration: s?.duration
      };
    }

    async function call(path, params) {
      const url = new URL(path, window.location.origin);
      if (params) Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      setOut('Loading...');
      const res = await fetch(url);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      return res.json();
    }

    document.getElementById('btnSearchV2').onclick = async () => {
      const q = document.getElementById('kw').value.trim();
      if (!q) return setOut('Vui lòng nhập từ khóa');
      document.getElementById('curlSearch').textContent = `curl "${window.location.origin.replace(/:\d+$/, ':8002')}/api/search?q=${encodeURIComponent(q)}"`;
      try {
        const res = await call('/api/search', { q });
        const songs = Array.isArray(res?.data?.songs) ? res.data.songs : [];
        const concise = songs.map(pickSongFields);
        if (concise[0]?.encodeId) {
          const inp = document.getElementById('songId');
          if (inp) inp.value = concise[0].encodeId;
        }
        setOut({ total: concise.length, songs: concise });
      } catch (e) {
        setOut(String(e));
      }
    };

    const player = document.getElementById('player');
    const direct128 = document.getElementById('direct128');
    const note128 = document.getElementById('note128');

    document.getElementById('btnPlay').onclick = () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return alert('Vui lòng nhập Song ID');
      const url = `/api/song/stream?id=${encodeURIComponent(id)}`;
      player.src = url;
      player.classList.remove('hidden');
      player.play();
      direct128.href = url;
      direct128.textContent = url;
      direct128.classList.remove('hidden');
      note128.classList.remove('hidden');
    };

    document.getElementById('btnGetLink').onclick = async () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return setOut('Vui lòng nhập Song ID');
      document.getElementById('curlGetLink').textContent = `curl "${window.location.origin.replace(/:\d+$/, ':8002')}/api/song?id=${encodeURIComponent(id)}"`;
      try {
        const res = await call('/api/song', { id });
        setOut(res);
      } catch (e) { setOut(String(e)); }
    };

    document.getElementById('btnInfoSong').onclick = async () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return setOut('Vui lòng nhập Song ID');
      try { setOut(await call('/api/info-song', { id })); } catch (e) { setOut(String(e)); }
    };

    document.getElementById('btnLyric').onclick = async () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return setOut('Vui lòng nhập Song ID');
      document.getElementById('curlLyric').textContent = `curl "${window.location.origin.replace(/:\d+$/, ':8002')}/api/lyric?id=${encodeURIComponent(id)}"`;
      try {
        const res = await call('/api/lyric', { id });
        const fileUrl = res?.data?.file;
        if (fileUrl && typeof fileUrl === 'string') {
          try {
            const resp = await fetch(fileUrl);
            const lrc = await resp.text();
            const text = lrc
              .split('\n')
              .map(line => line.replace(/\s*\[[^\]]*\]\s*/g, '').trim())
              .filter(Boolean)
              .join('\n');
            setOut(`"file": "${fileUrl}"\n\n${text}`);
          } catch (err) {
            setOut(res);
          }
        } else {
          setOut(res);
        }
      } catch (e) { setOut(String(e)); }
    };

    const newsCategorySelect = document.getElementById('newsCategorySelect');
    const newsOptions = [
      { value: 'latest', label: 'Tin mới nhất' },
      { value: 'thoi-su', label: 'Thời sự' },
      { value: 'the-gioi', label: 'Thế giới' },
      { value: 'kinh-doanh', label: 'Kinh doanh' },
      { value: 'giai-tri', label: 'Giải trí' },
      { value: 'the-thao', label: 'Thể thao' },
      { value: 'phap-luat', label: 'Pháp luật' },
      { value: 'giao-duc', label: 'Giáo dục' },
      { value: 'suc-khoe', label: 'Sức khỏe' },
      { value: 'doi-song', label: 'Đời sống' },
      { value: 'du-lich', label: 'Du lịch' },
      { value: 'khoa-hoc', label: 'Khoa học' },
      { value: 'so-hoa', label: 'Số hóa' },
      { value: 'oto-xe-may', label: 'Ôtô - Xe máy' },
      { value: 'y-kien', label: 'Ý kiến' }
    ];
    if (newsCategorySelect.childElementCount === 1) {
      newsOptions.slice(1).forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        newsCategorySelect.appendChild(option);
      });
    }

    document.getElementById('btnNewsFetch').onclick = async () => {
      const slug = newsCategorySelect.value;
      const isLatest = slug === 'latest';
      const path = isLatest ? '/api/news/latest' : '/api/news/category';
      const params = isLatest ? undefined : { slug };
      const base = window.location.origin.replace(/:\d+$/, ':8002');
      document.getElementById('curlNews').textContent = isLatest
        ? `curl "${base}/api/news/latest"`
        : `curl "${base}/api/news/category?slug=${slug}"`;
      try {
        const data = await call(path, params);
        setOut(data);
      } catch (err) {
        setOut(String(err));
      }
    };
  </script>
</body>
</html>
